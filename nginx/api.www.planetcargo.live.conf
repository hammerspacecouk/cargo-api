# HTTP Server - redirects to https and adds www
#server {
#        # Domains we are interested in
#        server_name api.www.planetcargo.live;
#
#        # Listen to correct ports
#        listen 80;
#        listen [::]:80;
#
#        # Redirect to HTTPS
#        return 301 https://api.www.planetcargo.live$request_uri;
#}

# Server
server {
    # Domains we are interested in
    server_name api.www.planetcargo.live api.beta.planetcargo.live api.alpha.planetcargo.live api.dev.planetcargo.live;

    # Listen to correct ports - todo ssl
    listen 80;
    listen [::]:80;

    keepalive_timeout 60;
    default_type text/html;
    charset UTF-8;

    # Path to public root
    root /var/www/api.www.planetcargo.live/public;

    # Store logs in the log folder
    error_log /var/log/nginx/api.www.planetcargo.live_error.log;
    access_log /var/log/nginx/api.www.planetcargo.live_access.log;

    # Not wise to tell the world exactly what version of software you are using
    server_tokens off;

    # Gzip Settings
    gzip on;
    gzip_disable "msie6";

    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/plain application/json;

    # lightweight health check for load balancer
    location = /health-alb {
        access_log off;
        return 200 'A-OK!';
        default_type text/plain;
    }

    # Don't log favicons
    location = /favicon.ico {
        return 404;
        access_log off;
        log_not_found off;
    }

    # Don't serve hidden files
    location ~ /\. {
        return 404;
        access_log off;
        log_not_found off;
    }

    # Run the Front Controller as PHP
    location ~ ^/index\.php(/|$) {
        fastcgi_pass unix:/run/php/php-fpm.sock;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        internal;

        # CORS headers - respond to the ORIGIN request for this header
        if ($http_origin ~* "^https?://(www|beta|alpha|dev)\.planetcargo\.live$" ) {
            add_header access-control-allow-origin $http_origin;
            add_header access-control-allow-credentials 'true';
        }
    }

    # Do not allow direct navigation to .php files
    location ~ \.php$ {
        return 404;
        access_log off;
        log_not_found off;
    }

    # Send all URLs to the front controller if the file doesn't exist directly
    location / {
        # try to serve file directly, fallback to app.php
        try_files $uri /index.php$is_args$args;
    }
}
