#!/usr/bin/env php
<?php
declare(strict_types=1);

use App\Kernel;
use Symfony\Bundle\FrameworkBundle\Console\Application;
use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Debug\Debug;

require_once __DIR__.'/../vendor/autoload.php';

date_default_timezone_set('UTC'); // servers should always be UTC

const ONE_SECOND = 1000000;

while (true) {
    gc_collect_cycles();
    $input = new ArgvInput();
    $env = $input->getParameterOption(['--env', '-e'], getenv('SYMFONY_ENV') ?: Kernel::ENV_PROD);
    $loopRest = (int) $input->getParameterOption(['--rest', '-r'], ONE_SECOND);
    $debug = getenv('SYMFONY_DEBUG') !== '0' && !$input->hasParameterOption(['--no-debug', '']) && $env !== 'prod';

    if ($debug) {
        Debug::enable();
    }

    usleep(random_int(0, $loopRest)); // prevent loop overload

    // todo - loggggggging

    $kernel = new Kernel($env, $debug);
    $application = new Application($kernel);
    $application->setAutoExit(false);

    try {
        $exitCode = $application->run($input);
    } catch (\Throwable $e) {
        // do nothing. loop round again - todo - log
        throw $e;
    }
    // todo - respond to broken exit codes
}
